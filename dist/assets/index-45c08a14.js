import{B as St,t as rt,i as Ct,a as Ut,b as S,A as It,c as Q,f as it,k as ot,d as ct,e as Ft,I as X,g as _t,h as dt,D as ut,j as pt,l as Nt,P as Vt,m as R,s as $t,r as D,p as $,o as Bt,Z as mt,n as yt,q as Ht,u as lt,v as Rt,w as Mt,x as j,y as ft,z as C,C as x,E as L,F as gt,G as z,H as I,J as v,K as b,L as ht,M as K,N as W,O as F,Q as kt,R as qt,S as At,T as jt,U as zt,V as Kt,W as Wt,X as O,Y as wt,_ as Zt,$ as Yt,a0 as Jt,a1 as Qt,a2 as Xt,a3 as te,a4 as U,a5 as _,a6 as tt,a7 as ee,a8 as ne,a9 as ae,aa as se,ab as re}from"./index-a005ad49.js";import{t as ie,p as oe,s as ce}from"./send-eip712-transaction-0a5b285e.js";class de extends St{constructor(n){super(`Filter type "${n}" is not supported.`,{name:"FilterTypeNotSupportedError"})}}const B=rt;function ue(t){const{abi:n,args:e=[],name:r}=t,o=Ct(r,{strict:!1}),a=n.filter(s=>o?s.type==="function"?Ut(s)===r:s.type==="event"?B(s)===r:!1:"name"in s&&s.name===r);if(a.length===0)return;if(a.length===1)return a[0];let i;for(const s of a){if(!("inputs"in s))continue;if(!e||e.length===0){if(!s.inputs||s.inputs.length===0)return s;continue}if(!s.inputs||s.inputs.length===0||s.inputs.length!==e.length)continue;if(e.every((d,p)=>{const m="inputs"in s&&s.inputs[p];return m?M(d,m):!1})){if(i&&"inputs"in i&&i.inputs){const d=Gt(s.inputs,i.inputs,e);if(d)throw new It({abiItem:s,type:d[0]},{abiItem:i,type:d[1]})}i=s}}return i||a[0]}function M(t,n){const e=typeof t,r=n.type;switch(r){case"address":return S(t,{strict:!1});case"bool":return e==="boolean";case"function":return e==="string";case"string":return e==="string";default:return r==="tuple"&&"components"in n?Object.values(n.components).every((o,a)=>M(Object.values(t)[a],o)):/^u?int(8|16|24|32|40|48|56|64|72|80|88|96|104|112|120|128|136|144|152|160|168|176|184|192|200|208|216|224|232|240|248|256)?$/.test(r)?e==="number"||e==="bigint":/^bytes([1-9]|1[0-9]|2[0-9]|3[0-2])?$/.test(r)?e==="string"||t instanceof Uint8Array:/[a-z]+[1-9]{0,3}(\[[0-9]{0,}\])+$/.test(r)?Array.isArray(t)&&t.every(o=>M(o,{...n,type:r.replace(/(\[[0-9]{0,}\])$/,"")})):!1}}function Gt(t,n,e){for(const r in t){const o=t[r],a=n[r];if(o.type==="tuple"&&a.type==="tuple"&&"components"in o&&"components"in a)return Gt(o.components,a.components,e[r]);const i=[o.type,a.type];if((()=>i.includes("address")&&i.includes("bytes20")?!0:i.includes("address")&&i.includes("string")?S(e[r],{strict:!1}):i.includes("address")&&i.includes("bytes")?S(e[r],{strict:!1}):!1)())return i}}const et="/docs/contract/encodeEventTopics";function pe(t){var c;const{abi:n,eventName:e,args:r}=t;let o=n[0];if(e){const d=ue({abi:n,name:e});if(!d)throw new Q(e,{docsPath:et});o=d}if(o.type!=="event")throw new Q(void 0,{docsPath:et});const a=it(o),i=B(a);let s=[];if(r&&"inputs"in o){const d=(c=o.inputs)==null?void 0:c.filter(m=>"indexed"in m&&m.indexed),p=Array.isArray(r)?r:Object.values(r).length>0?(d==null?void 0:d.map(m=>r[m.name]))??[]:[];p.length>0&&(s=(d==null?void 0:d.map((m,u)=>Array.isArray(p[u])?p[u].map((A,h)=>nt({param:m,value:p[u][h]})):typeof p[u]<"u"&&p[u]!==null?nt({param:m,value:p[u]}):null))??[])}return[i,...s]}function nt({param:t,value:n}){if(t.type==="string"||t.type==="bytes")return ot(ct(n));if(t.type==="tuple"||t.type.match(/^(.*)\[(\d+)?\]$/))throw new de(t.type);return Ft([t],[n])}function me(t,n){if(!S(t,{strict:!1}))throw new X({address:t});if(!S(n,{strict:!1}))throw new X({address:n});return t.toLowerCase()===n.toLowerCase()}const at="/docs/contract/decodeEventLog";function ye(t){const{abi:n,data:e,strict:r,topics:o}=t,a=r??!0,[i,...s]=o;if(!i)throw new _t({docsPath:at});const c=(()=>n.length===1?n[0]:n.find(l=>l.type==="event"&&i===B(it(l))))();if(!(c&&"name"in c)||c.type!=="event")throw new dt(i,{docsPath:at});const{name:d,inputs:p}=c,m=p==null?void 0:p.some(l=>!("name"in l&&l.name));let u=m?[]:{};const A=p.filter(l=>"indexed"in l&&l.indexed);for(let l=0;l<A.length;l++){const w=A[l],g=s[l];if(!g)throw new ut({abiItem:c,param:w});u[m?l:w.name||l]=le({param:w,value:g})}const h=p.filter(l=>!("indexed"in l&&l.indexed));if(h.length>0){if(e&&e!=="0x")try{const l=pt(h,e);if(l)if(m)u=[...u,...l];else for(let w=0;w<h.length;w++)u[h[w].name]=l[w]}catch(l){if(a)throw l instanceof Nt||l instanceof Vt?new R({abiItem:c,data:e,params:h,size:$t(e)}):l}else if(a)throw new R({abiItem:c,data:"0x",params:h,size:0})}return{eventName:d,args:Object.values(u).length>0?u:void 0}}function le({param:t,value:n}){return t.type==="string"||t.type==="bytes"||t.type==="tuple"||t.type.match(/^(.*)\[(\d+)?\]$/)?n:(pt([t],n)||[])[0]}function fe(t){const{abi:n,args:e,logs:r,strict:o=!0}=t,a=(()=>{if(t.eventName)return Array.isArray(t.eventName)?t.eventName:[t.eventName]})();return r.map(i=>{var s;try{const c=n.find(p=>p.type==="event"&&i.topics[0]===B(p));if(!c)return null;const d=ye({...i,abi:[c],strict:o});return a&&!a.includes(d.eventName)||!ge({args:d.args,inputs:c.inputs,matchArgs:e})?null:{...d,...i}}catch(c){let d,p;if(c instanceof dt)return null;if(c instanceof R||c instanceof ut){if(o)return null;d=c.abiItem.name,p=(s=c.abiItem.inputs)==null?void 0:s.some(m=>!("name"in m&&m.name))}return{...i,args:p?[]:{},eventName:d}}}).filter(Boolean)}function ge(t){const{args:n,inputs:e,matchArgs:r}=t;if(!r)return!0;if(!n)return!1;function o(a,i,s){try{return a.type==="address"?me(i,s):a.type==="string"||a.type==="bytes"?ot(ct(i))===s:i===s}catch{return!1}}return Array.isArray(n)&&Array.isArray(r)?r.every((a,i)=>{if(a==null)return!0;const s=e[i];return s?(Array.isArray(a)?a:[a]).some(d=>o(s,d,n[i])):!1}):typeof n=="object"&&!Array.isArray(n)&&typeof r=="object"&&!Array.isArray(r)?Object.entries(r).every(([a,i])=>{if(i==null)return!0;const s=e.find(d=>d.name===a);return s?(Array.isArray(i)?i:[i]).some(d=>o(s,d,n[a])):!1}):!1}const he="0xf15d424e",Ae=[{type:"address",name:"signer"}],we=[{type:"tuple",name:"permissions",components:[{type:"address",name:"signer"},{type:"address[]",name:"approvedTargets"},{type:"uint256",name:"nativeTokenLimitPerTransaction"},{type:"uint128",name:"startTimestamp"},{type:"uint128",name:"endTimestamp"}]}];async function Ge(t){return D({contract:t.contract,method:[he,Ae,we],params:[t.signer]})}const ve="0x5892e236",Te=[{type:"tuple",name:"req",components:[{type:"address",name:"signer"},{type:"uint8",name:"isAdmin"},{type:"address[]",name:"approvedTargets"},{type:"uint256",name:"nativeTokenLimitPerTransaction"},{type:"uint128",name:"permissionStartTimestamp"},{type:"uint128",name:"permissionEndTimestamp"},{type:"uint128",name:"reqValidityStartTimestamp"},{type:"uint128",name:"reqValidityEndTimestamp"},{type:"bytes32",name:"uid"}]},{type:"bytes",name:"signature"}],Pe=[];function be(t){const n=Bt(async()=>"asyncParams"in t?await t.asyncParams():t);return $({contract:t.contract,method:[ve,Te,Pe],params:async()=>{const e=await n();return[e.req,e.signature]},value:async()=>{var e;return(e=(await n()).overrides)==null?void 0:e.value},accessList:async()=>{var e;return(e=(await n()).overrides)==null?void 0:e.accessList},gas:async()=>{var e;return(e=(await n()).overrides)==null?void 0:e.gas},gasPrice:async()=>{var e;return(e=(await n()).overrides)==null?void 0:e.gasPrice},maxFeePerGas:async()=>{var e;return(e=(await n()).overrides)==null?void 0:e.maxFeePerGas},maxPriorityFeePerGas:async()=>{var e;return(e=(await n()).overrides)==null?void 0:e.maxPriorityFeePerGas},nonce:async()=>{var e;return(e=(await n()).overrides)==null?void 0:e.nonce},extraGas:async()=>{var e;return(e=(await n()).overrides)==null?void 0:e.extraGas},erc20Value:async()=>{var e;return(e=(await n()).overrides)==null?void 0:e.erc20Value}})}function st(){return new Date(Date.now()+1e3*60*60*24*365*10)}function H(t){return ie(Math.floor(t.getTime()/1e3))}const Oe=[{name:"signer",type:"address"},{name:"isAdmin",type:"uint8"},{name:"approvedTargets",type:"address[]"},{name:"nativeTokenLimitPerTransaction",type:"uint256"},{name:"permissionStartTimestamp",type:"uint128"},{name:"permissionEndTimestamp",type:"uint128"},{name:"reqValidityStartTimestamp",type:"uint128"},{name:"reqValidityEndTimestamp",type:"uint128"},{name:"uid",type:"bytes32"}];async function xe(t){const{account:n,contract:e,req:r}=t,o=await n.signTypedData({domain:{name:"Account",version:"1",verifyingContract:e.address,chainId:e.chain.id},primaryType:"SignerPermissionRequest",types:{SignerPermissionRequest:Oe},message:r});return{req:r,signature:o}}async function Le(t){var r;const{target:n,permissions:e}=t;return{approvedTargets:e.approvedTargets==="*"?[mt]:e.approvedTargets,nativeTokenLimitPerTransaction:yt(((r=e.nativeTokenLimitPerTransaction)==null?void 0:r.toString())||"0"),permissionStartTimestamp:H(e.permissionStartTimestamp||new Date(0)),permissionEndTimestamp:H(e.permissionEndTimestamp||st()),reqValidityStartTimestamp:0n,reqValidityEndTimestamp:H(st()),uid:await Ht(),isAdmin:0,signer:n}}function De(t){const{contract:n,sessionKeyAddress:e,account:r,permissions:o}=t;return be({contract:n,async asyncParams(){const{req:a,signature:i}=await xe({account:r,contract:n,req:await Le({target:e,permissions:o})});return{signature:i,req:a}}})}async function Ee(t){var i;const{accountContract:n,sessionKeyAddress:e,newPermissions:r}=t;if(!await lt(n))return!0;const a=await Ge({contract:n,signer:e});return!!(a.endTimestamp&&a.endTimestamp<Math.floor(new Date().getTime()/1e3)||!Se(a.approvedTargets,r.approvedTargets)||yt(((i=r.nativeTokenLimitPerTransaction)==null?void 0:i.toString())??"0")>a.nativeTokenLimitPerTransaction)}function Se(t,n){return n==="*"&&t.length===1&&t[0]===mt?!0:n!=="*"?n.map(e=>e.toLowerCase()).every(e=>t.map(r=>r.toLowerCase()).includes(e)):!1}const Ce=2n**96n-1n;function Ue(t){const{logs:n,events:e,strict:r}=t;return fe({logs:n,abi:e.map(o=>o.abiEvent),strict:r})}function Ie(t){return!!(t&&typeof t=="object"&&"type"in t&&t.type==="event")}function vt(t){const{signature:n}=t;let e;return Ie(n)?e=n:e=Rt(n),{abiEvent:e,hash:rt(e),topics:pe({abi:[e],args:t.filters})}}function Fe(t={}){return vt({signature:"event UserOperationRevertReason(bytes32 indexed userOpHash, address indexed sender, uint256 nonce, bytes revertReason)",filters:t})}function _e(t={}){return vt({signature:"event PostOpRevertReason(bytes32 indexed userOpHash, address indexed sender, uint256 nonce, bytes revertReason)",filters:t})}function Ne(t){const{receipt:n}=t,e={...n,transactionHash:n.transactionHash,blockNumber:n.blockNumber?BigInt(n.blockNumber):null,contractAddress:n.contractAddress?n.contractAddress:null,cumulativeGasUsed:n.cumulativeGasUsed?BigInt(n.cumulativeGasUsed):null,effectiveGasPrice:n.effectiveGasPrice?BigInt(n.effectiveGasPrice):null,gasUsed:n.gasUsed?BigInt(n.gasUsed):null,logs:n.logs,to:n.to?n.to:null,transactionIndex:n.transactionIndex,status:n.status,type:n.type};return n.blobGasPrice&&(e.blobGasPrice=BigInt(n.blobGasPrice)),n.blobGasUsed&&(e.blobGasUsed=BigInt(n.blobGasUsed)),{...t,receipt:e,userOpHash:t.userOpHash,actualGasCost:BigInt(t.actualGasCost),actualGasUsed:BigInt(t.actualGasUsed),nonce:BigInt(t.nonce)}}async function Ve(t){const{factoryContract:n,predictAddressOverride:e,adminAddress:r,accountSalt:o,accountAddress:a}=t;if(e)return e(n,r);if(a)return a;if(!r)throw new Error("Account address is required to predict the smart wallet address.");return Mt(async()=>{const i=o&&j(o)?o:ft(o??"");return D({contract:n,method:"function getAddress(address, bytes) returns (address)",params:[r,i]})},{cacheKey:`${t.factoryContract.chain.id}-${t.factoryContract.address}-${t.adminAddress}-${t.accountSalt}`,cacheTime:1e3*60*60*24})}function Tt(t){const{adminAddress:n,factoryContract:e,createAccountOverride:r,accountSalt:o}=t;if(r)return r(e,n);const a=o&&j(o)?o:ft(o??"");return $({contract:e,method:"function createAccount(address, bytes) returns (address)",params:[n,a]})}function Pt(t){const{accountContract:n,transaction:e,executeOverride:r}=t;return r?r(n,e):$({contract:n,method:"function execute(address, uint256, bytes)",params:[e.to||"",e.value||0n,e.data||"0x"],gas:e.gas?e.gas+21000n:void 0})}function $e(t){const{accountContract:n,transactions:e,executeBatchOverride:r}=t;return r?r(n,e):$({contract:n,method:"function executeBatch(address[], uint256[], bytes[])",params:[e.map(o=>o.to||""),e.map(o=>o.value||0n),e.map(o=>o.data||"0x")]})}const Be="0x35567e1a",He=[{type:"address",name:"sender"},{type:"uint192",name:"key"}],Re=[{type:"uint256",name:"nonce"}];async function Me(t){return D({contract:t.contract,method:[Be,He,Re],params:[t.sender,t.key]})}const ke="0xa6193531",qe=[{type:"tuple",name:"userOp",components:[{type:"address",name:"sender"},{type:"uint256",name:"nonce"},{type:"bytes",name:"initCode"},{type:"bytes",name:"callData"},{type:"uint256",name:"callGasLimit"},{type:"uint256",name:"verificationGasLimit"},{type:"uint256",name:"preVerificationGas"},{type:"uint256",name:"maxFeePerGas"},{type:"uint256",name:"maxPriorityFeePerGas"},{type:"bytes",name:"paymasterAndData"},{type:"bytes",name:"signature"}]}],je=[{type:"bytes32"}];async function ze(t){return D({contract:t.contract,method:[ke,qe,je],params:[t.userOp]})}const Ke="0x22cdde4c",We=[{type:"tuple",name:"userOp",components:[{type:"address",name:"sender"},{type:"uint256",name:"nonce"},{type:"bytes",name:"initCode"},{type:"bytes",name:"callData"},{type:"bytes32",name:"accountGasLimits"},{type:"uint256",name:"preVerificationGas"},{type:"bytes32",name:"gasFees"},{type:"bytes",name:"paymasterAndData"},{type:"bytes",name:"signature"}]}],Ze=[{type:"bytes32"}];async function Ye(t){return D({contract:t.contract,method:[Ke,We,Ze],params:[t.userOp]})}function Je(t){return t.factory?C([t.factory,t.factoryData||"0x"]):"0x"}function Qe(t){return C([x(L(BigInt(t.verificationGasLimit)),{size:16}),x(L(BigInt(t.callGasLimit)),{size:16})])}function Xe(t){return C([x(L(BigInt(t.maxPriorityFeePerGas)),{size:16}),x(L(BigInt(t.maxFeePerGas)),{size:16})])}function tn(t){return t.paymaster?C([t.paymaster,x(L(BigInt(t.paymasterVerificationGasLimit||0)),{size:16}),x(L(BigInt(t.paymasterPostOpGasLimit||0)),{size:16}),t.paymasterData||"0x"]):"0x"}const en=t=>({sender:t.sender,nonce:BigInt(t.nonce),initCode:Je(t),callData:t.callData,accountGasLimits:Qe(t),preVerificationGas:BigInt(t.preVerificationGas),gasFees:Xe(t),paymasterAndData:tn(t),signature:t.signature}),nn=()=>{const t=BigInt(Math.floor(Math.random()*4294967296)),n=BigInt(Math.floor(Math.random()*4294967296)),e=BigInt(Math.floor(Math.random()*4294967296)),r=BigInt(Math.floor(Math.random()*4294967296)),o=BigInt(Math.floor(Math.random()*4294967296)),a=BigInt(Math.floor(Math.random()*4294967296));return t<<BigInt(160)|n<<BigInt(128)|e<<BigInt(96)|r<<BigInt(64)|o<<BigInt(32)|a};function Z(t){return Object.fromEntries(Object.entries(t).map(([n,e])=>[n,e==null||j(e)?e:gt(e)]))}async function N(t){var h;const{userOp:n,paymasterOverride:e,client:r,chain:o,entrypointAddress:a}=t;if(e)return e(n);const i={"Content-Type":"application/json"},s=a??b,c=z(o),d={jsonrpc:"2.0",id:1,method:"pm_sponsorUserOperation",params:[Z(n),s]},m=await ht(r)(c,{method:"POST",headers:i,body:I(d)}),u=await m.json();if(!m.ok){const l=u.error||m.statusText,w=u.code||"UNKNOWN";throw new Error(`Paymaster error: ${l}
Status: ${m.status}
Code: ${w}`)}if(u.result)return typeof u.result=="string"?{paymasterAndData:u.result}:(u.result.policyId&&u.result.reason&&console.warn(`Paymaster policy rejected this transaction with reason: ${u.result.reason} (policyId: ${u.result.policyId})`),{paymasterAndData:u.result.paymasterAndData,verificationGasLimit:u.result.verificationGasLimit?v(u.result.verificationGasLimit):void 0,preVerificationGas:u.result.preVerificationGas?v(u.result.preVerificationGas):void 0,callGasLimit:u.result.callGasLimit?v(u.result.callGasLimit):void 0,paymaster:u.result.paymaster,paymasterData:u.result.paymasterData,paymasterVerificationGasLimit:u.result.paymasterVerificationGasLimit?v(u.result.paymasterVerificationGasLimit):void 0,paymasterPostOpGasLimit:u.result.paymasterPostOpGasLimit?v(u.result.paymasterPostOpGasLimit):void 0});const A=((h=u.error)==null?void 0:h.message)||u.error||m.statusText||"unknown error";throw new Error(`Paymaster error from ${c}: ${A}`)}const Y=new Set,J=t=>`${t.chain.id}:${t.address}`,bt=t=>{Y.add(J(t))},Ot=t=>{Y.delete(J(t))},xt=t=>Y.has(J(t));async function an(t){const n=t.timeoutMs||12e4,e=t.intervalMs||1e3,r=Date.now()+n;for(;Date.now()<r;){const o=await fn(t);if(o)return o;await new Promise(a=>setTimeout(a,e))}throw new Error(`Timeout waiting for userOp to be mined on chain ${t.chain.id} with UserOp hash: ${t.userOpHash}`)}async function sn(t){var G;const{transaction:n,accountContract:e,factoryContract:r,adminAddress:o,overrides:a,sponsorGas:i,waitForDeployment:s=!0,isDeployedOverride:c}=t,d=n.chain,p=n.client,m={client:p,chain:d,bundlerUrl:a==null?void 0:a.bundlerUrl,entrypointAddress:a==null?void 0:a.entrypointAddress},u=K(((G=t.overrides)==null?void 0:G.entrypointAddress)||b),[A,h,l,w,g]=await Promise.all([typeof c=="boolean"?c:lt(e).then(T=>T||xt(e)),W(n),F(n.gas),rn({executeTx:n,bundlerOptions:m,chain:d,client:p}),mn({accountContract:e,chain:d,client:p,entrypointAddress:a==null?void 0:a.entrypointAddress,getNonceOverride:a==null?void 0:a.getAccountNonce})]),{maxFeePerGas:y,maxPriorityFeePerGas:f}=w;return u==="v0.7"?on({bundlerOptions:m,factoryContract:r,accountContract:e,adminAddress:o,sponsorGas:i,overrides:a,isDeployed:A,nonce:g,callData:h,callGasLimit:l,maxFeePerGas:y,maxPriorityFeePerGas:f,waitForDeployment:s}):cn({bundlerOptions:m,factoryContract:r,accountContract:e,adminAddress:o,sponsorGas:i,overrides:a,isDeployed:A,nonce:g,callData:h,callGasLimit:l,maxFeePerGas:y,maxPriorityFeePerGas:f,waitForDeployment:s})}async function rn(t){const{executeTx:n,bundlerOptions:e,chain:r,client:o}=t;let{maxFeePerGas:a,maxPriorityFeePerGas:i}=n;const s=(e==null?void 0:e.bundlerUrl)??z(r);if(kt(s)){const c=await ln({options:e});a=c.maxFeePerGas,i=c.maxPriorityFeePerGas}else{const[c,d]=await Promise.all([F(a),F(i)]);if(c&&d)a=c,i=d;else{const p=await qt(o,r);i=d??p.maxPriorityFeePerGas??0n,a=c??p.maxFeePerGas??0n}}return{maxFeePerGas:a,maxPriorityFeePerGas:i}}async function on(t){const{bundlerOptions:n,isDeployed:e,factoryContract:r,accountContract:o,adminAddress:a,sponsorGas:i,overrides:s,nonce:c,callData:d,callGasLimit:p,maxFeePerGas:m,maxPriorityFeePerGas:u,waitForDeployment:A}=t,{chain:h,client:l}=n;let w,g;e?(g="0x",A&&await Lt(o)):(w=r.address,g=await W(Tt({factoryContract:r,adminAddress:a,accountSalt:s==null?void 0:s.accountSalt,createAccountOverride:s==null?void 0:s.createAccount})),A&&bt(o));const y={sender:o.address,nonce:c,callData:d,maxFeePerGas:m,maxPriorityFeePerGas:u,callGasLimit:p??0n,verificationGasLimit:0n,preVerificationGas:0n,factory:w,factoryData:g,paymaster:void 0,paymasterData:"0x",paymasterVerificationGasLimit:0n,paymasterPostOpGasLimit:0n,signature:At};if(i){const f=await N({userOp:y,chain:h,client:l,entrypointAddress:s==null?void 0:s.entrypointAddress,paymasterOverride:s==null?void 0:s.paymaster});if(f.paymaster&&f.paymasterData&&(y.paymaster=f.paymaster,y.paymasterData=f.paymasterData),f.callGasLimit&&f.verificationGasLimit&&f.preVerificationGas&&f.paymasterPostOpGasLimit&&f.paymasterVerificationGasLimit)y.callGasLimit=f.callGasLimit,y.verificationGasLimit=f.verificationGasLimit,y.preVerificationGas=f.preVerificationGas,y.paymasterPostOpGasLimit=f.paymasterPostOpGasLimit,y.paymasterVerificationGasLimit=f.paymasterVerificationGasLimit;else{const G=s!=null&&s.tokenPaymaster?{[s.tokenPaymaster.tokenAddress]:{stateDiff:{[jt(zt([{type:"address"},{type:"uint256"}],[o.address,s.tokenPaymaster.balanceStorageSlot]))]:gt(Kt,{size:32})}}}:void 0,T=await V({userOp:y,options:n},G);y.callGasLimit=T.callGasLimit,y.verificationGasLimit=T.verificationGasLimit,y.preVerificationGas=T.preVerificationGas,y.paymasterPostOpGasLimit=s!=null&&s.tokenPaymaster?500000n:T.paymasterPostOpGasLimit||0n,y.paymasterVerificationGasLimit=T.paymasterVerificationGasLimit||0n;const P=await N({userOp:y,chain:h,client:l,entrypointAddress:s==null?void 0:s.entrypointAddress,paymasterOverride:s==null?void 0:s.paymaster});P.paymaster&&P.paymasterData&&(y.paymaster=P.paymaster,y.paymasterData=P.paymasterData)}}else{const f=await V({userOp:y,options:n});y.callGasLimit=f.callGasLimit,y.verificationGasLimit=f.verificationGasLimit,y.preVerificationGas=f.preVerificationGas,y.paymasterPostOpGasLimit=f.paymasterPostOpGasLimit||0n,y.paymasterVerificationGasLimit=f.paymasterVerificationGasLimit||0n}return{...y,signature:"0x"}}async function cn(t){const{bundlerOptions:n,isDeployed:e,factoryContract:r,accountContract:o,adminAddress:a,sponsorGas:i,overrides:s,nonce:c,callData:d,callGasLimit:p,maxFeePerGas:m,maxPriorityFeePerGas:u,waitForDeployment:A}=t,{chain:h,client:l}=n;let w;e?(w="0x",A&&await Lt(o)):(w=await pn({factoryContract:r,adminAddress:a,accountSalt:s==null?void 0:s.accountSalt,createAccountOverride:s==null?void 0:s.createAccount}),A&&bt(o));const g={sender:o.address,nonce:c,initCode:w,callData:d,maxFeePerGas:m,maxPriorityFeePerGas:u,callGasLimit:p??0n,verificationGasLimit:0n,preVerificationGas:0n,paymasterAndData:"0x",signature:At};if(i){const y=await N({userOp:g,chain:h,client:l,entrypointAddress:s==null?void 0:s.entrypointAddress,paymasterOverride:s==null?void 0:s.paymaster}),f="paymasterAndData"in y?y.paymasterAndData:"0x";if(f&&f!=="0x"&&(g.paymasterAndData=f),y.callGasLimit&&y.verificationGasLimit&&y.preVerificationGas)g.callGasLimit=y.callGasLimit,g.verificationGasLimit=y.verificationGasLimit,g.preVerificationGas=y.preVerificationGas;else{const G=await V({userOp:g,options:n});if(g.callGasLimit=G.callGasLimit,g.verificationGasLimit=G.verificationGasLimit,g.preVerificationGas=G.preVerificationGas,f&&f!=="0x"){const T=await N({userOp:g,chain:h,client:l,entrypointAddress:s==null?void 0:s.entrypointAddress,paymasterOverride:s==null?void 0:s.paymaster}),P="paymasterAndData"in T?T.paymasterAndData:"0x";P&&P!=="0x"&&(g.paymasterAndData=P)}}}else{const y=await V({userOp:g,options:n});g.callGasLimit=y.callGasLimit,g.verificationGasLimit=y.verificationGasLimit,g.preVerificationGas=y.preVerificationGas}return{...g,signature:"0x"}}async function dn(t){const{userOp:n,chain:e,entrypointAddress:r,adminAccount:o}=t,a=await un({client:t.client,userOp:n,chain:e,entrypointAddress:r});if(o.signMessage){const i=await o.signMessage({message:{raw:Wt(a)},originalMessage:I(n),chainId:e.id});return{...n,signature:i}}throw new Error("signMessage not implemented in signingAccount")}async function un(t){const{userOp:n,chain:e,entrypointAddress:r}=t,o=K(r||b);let a;if(o==="v0.7"){const i=en(n);a=await Ye({contract:O({address:r||wt,chain:e,client:t.client}),userOp:i})}else a=await ze({contract:O({address:r||b,chain:e,client:t.client}),userOp:n});return a}async function pn(t){const{factoryContract:n,adminAddress:e,accountSalt:r,createAccountOverride:o}=t,a=Tt({factoryContract:n,adminAddress:e,accountSalt:r,createAccountOverride:o});return C([n.address,await W(a)])}async function mn(t){const{accountContract:n,chain:e,client:r,entrypointAddress:o,getNonceOverride:a}=t;return a?a(n):await Me({contract:O({address:o||b,chain:e,client:r}),key:nn(),sender:n.address})}async function Lt(t){const n=Date.now();for(;xt(t);){if(Date.now()-n>6e4)throw Ot(t),new Error("Account deployment is taking too long (over 1 minute). Please try again.");await new Promise(e=>setTimeout(e,500))}}async function yn(t){return E({...t,operation:"eth_sendUserOperation",params:[Z(t.userOp),t.options.entrypointAddress??b]})}async function V(t,n){const e=await E({...t,operation:"eth_estimateUserOperationGas",params:[Z(t.userOp),t.options.entrypointAddress??b,n??{}]});return{preVerificationGas:v(e.preVerificationGas),verificationGas:e.verificationGas!==void 0?v(e.verificationGas):void 0,verificationGasLimit:v(e.verificationGasLimit),callGasLimit:v(e.callGasLimit)+Zt,paymasterVerificationGasLimit:e.paymasterVerificationGasLimit!==void 0?v(e.paymasterVerificationGasLimit):void 0,paymasterPostOpGasLimit:e.paymasterPostOpGasLimit!==void 0?v(e.paymasterPostOpGasLimit):void 0}}async function ln(t){const n=await E({...t,operation:"thirdweb_getUserOperationGasPrice",params:[]});return{maxPriorityFeePerGas:v(n.maxPriorityFeePerGas),maxFeePerGas:v(n.maxFeePerGas)}}async function fn(t){var e,r;const n=await gn(t);if(n){if(n.success===!1){const a=(r=(e=Ue({events:[Fe(),_e()],logs:n.logs})[0])==null?void 0:e.args)==null?void 0:r.revertReason;if(!a)throw new Error(`UserOp failed at txHash: ${n.receipt.transactionHash}`);const i=Yt({data:a});throw new Error(`UserOp failed with reason: '${i.args.join(",")}' at txHash: ${n.receipt.transactionHash}`)}return n.receipt}}async function gn(t){const n=await E({options:t,operation:"eth_getUserOperationReceipt",params:[t.userOpHash]});if(n)return Ne(n)}async function hn(t){const n=await E({options:t.options,operation:"zk_paymasterData",params:[t.transaction]});return{paymaster:n.paymaster,paymasterInput:n.paymasterInput}}async function An(t){return{transactionHash:(await E({options:t.options,operation:"zk_broadcastTransaction",params:[{...t.transaction,signedTransaction:t.signedTransaction}]})).transactionHash}}async function E(t){const{options:n,operation:e,params:r}=t,o=n.bundlerUrl??z(n.chain),i=await ht(n.client)(o,{method:"POST",headers:{"Content-Type":"application/json"},body:I({jsonrpc:"2.0",id:1,method:e,params:r})}),s=await i.json();if(!i.ok||s.error){let c=s.error||i.statusText;typeof c=="object"&&(c=I(c));const d=s.code||"UNKNOWN";throw new Error(`${e} error: ${c}
Status: ${i.status}
Code: ${d}`)}return s.result}const Dt=new WeakMap,k=new WeakMap;async function wn(t,n){var A,h,l,w,g,y,f;const{personalAccount:e,client:r,chain:o}=t;if(!e)throw new Error("No personal account provided for smart account connection");const a=n,i=o??a.chain,s="gasless"in a?a.gasless:a.sponsorGas;if(await Jt(i))return[Pn({creationOptions:n,connectionOptions:t,chain:i,sponsorGas:s}),i];if(a.factoryAddress&&!((A=a.overrides)!=null&&A.entrypointAddress)){const G=await Et(a.factoryAddress,r,i);G&&(a.overrides={...a.overrides,entrypointAddress:G})}(h=a.overrides)!=null&&h.tokenPaymaster&&!((l=a.overrides)!=null&&l.entrypointAddress)&&(a.overrides={...a.overrides,entrypointAddress:wt});const c=a.factoryAddress??Qt((w=a.overrides)==null?void 0:w.entrypointAddress),d=O({client:r,address:c,chain:i}),p=await Ve({factoryContract:d,adminAddress:e.address,predictAddressOverride:(g=a.overrides)==null?void 0:g.predictAddress,accountSalt:(y=a.overrides)==null?void 0:y.accountSalt,accountAddress:(f=a.overrides)==null?void 0:f.accountAddress}).then(G=>G).catch(G=>{throw new Error(`Failed to get account address with factory contract ${d.address} on chain ID ${i.id}: ${(G==null?void 0:G.message)||"unknown error"}`,{cause:G})}),m=O({client:r,address:p,chain:i}),u=await vn({...a,chain:i,sponsorGas:s,personalAccount:e,accountContract:m,factoryContract:d,client:r});if(Dt.set(e,u),k.set(u,e),a.sessionKey&&await Ee({accountContract:m,sessionKeyAddress:a.sessionKey.address,newPermissions:a.sessionKey.permissions})){const G=De({account:e,contract:m,permissions:a.sessionKey.permissions,sessionKeyAddress:a.sessionKey.address});await Xt({account:u,transaction:G})}return[u,i]}async function Gn(t){const n=k.get(t);n&&(Dt.delete(n),k.delete(t))}async function vn(t){var o,a;const n=(o=t.overrides)==null?void 0:o.tokenPaymaster;if(n&&K(((a=t.overrides)==null?void 0:a.entrypointAddress)||b)!=="v0.7")throw new Error("Token paymaster is only supported for entrypoint version v0.7");let e=t.accountContract;const r={address:te(e.address),async sendTransaction(i){var m,u,A;let s;if(n){await Tn({accountContract:e,erc20Paymaster:n,options:t});const h=async()=>({paymaster:n.paymasterAddress,paymasterData:"0x"});s=((m=t.overrides)==null?void 0:m.paymaster)||h}else s=(u=t.overrides)==null?void 0:u.paymaster;i.chainId!==e.chain.id&&(e=O({address:r.address,chain:U(i.chainId),client:t.client}));const c=Pt({accountContract:e,transaction:i,executeOverride:(A=t.overrides)==null?void 0:A.execute}),d=U(i.chainId),p=await q({executeTx:c,options:{...t,chain:d,accountContract:e,overrides:{...t.overrides,paymaster:s}}});return _({client:t.client,chainId:d.id,transactionHash:p.transactionHash,walletAddress:t.accountContract.address,walletType:"smart",contractAddress:i.to??void 0}),p},async sendBatchTransaction(i){var m,u;const s=$e({accountContract:e,transactions:i,executeBatchOverride:(m=t.overrides)==null?void 0:m.executeBatch});if(i.length===0)throw new Error("No transactions to send");const c=i[0];if(!c)throw new Error("No transactions to send");const d=U(c.chainId),p=await q({executeTx:s,options:{...t,chain:d,accountContract:e}});return _({client:t.client,chainId:d.id,transactionHash:p.transactionHash,walletAddress:t.accountContract.address,walletType:"smart",contractAddress:((u=i[0])==null?void 0:u.to)??void 0}),p},async signMessage({message:i}){var c;if((c=t.overrides)!=null&&c.signMessage)return t.overrides.signMessage({adminAccount:t.personalAccount,factoryContract:t.factoryContract,accountContract:e,message:i});const{smartAccountSignMessage:s}=await tt(()=>import("./signing-a76c16c2.js"),["assets/signing-a76c16c2.js","assets/index-a005ad49.js","assets/index-fae58ef4.css","assets/concat-hex-f6252d40.js","assets/Signature-48d91ea5.js","assets/send-eip712-transaction-0a5b285e.js","assets/eth_sendRawTransaction-5ae15b91.js"]);return s({accountContract:e,factoryContract:t.factoryContract,options:t,message:i})},async signTypedData(i){var c;if((c=t.overrides)!=null&&c.signTypedData)return t.overrides.signTypedData({adminAccount:t.personalAccount,factoryContract:t.factoryContract,accountContract:e,typedData:i});const{smartAccountSignTypedData:s}=await tt(()=>import("./signing-a76c16c2.js"),["assets/signing-a76c16c2.js","assets/index-a005ad49.js","assets/index-fae58ef4.css","assets/concat-hex-f6252d40.js","assets/Signature-48d91ea5.js","assets/send-eip712-transaction-0a5b285e.js","assets/eth_sendRawTransaction-5ae15b91.js"]);return s({accountContract:e,factoryContract:t.factoryContract,options:t,typedData:i})},async onTransactionRequested(i){var s,c;return(c=(s=t.personalAccount).onTransactionRequested)==null?void 0:c.call(s,i)}};return r}async function Tn(t){var p;const{accountContract:n,erc20Paymaster:e,options:r}=t,o=e.tokenAddress,a=O({address:o,chain:n.chain,client:n.client});if(await ee({contract:a,owner:n.address,spender:e.paymasterAddress})>0n)return;const s=ne({contract:a,spender:e.paymasterAddress,amountWei:Ce-1n}),c=await ae({transaction:s,from:n.address}),d=Pt({accountContract:n,transaction:c,executeOverride:(p=r.overrides)==null?void 0:p.execute});await q({executeTx:d,options:{...r,overrides:{...r.overrides,tokenPaymaster:void 0}}})}function Pn(t){const{creationOptions:n,connectionOptions:e,chain:r}=t,o={address:e.personalAccount.address,async sendTransaction(a){var p,m,u,A;const i={data:a.data,to:a.to??void 0,value:a.value??0n,chain:U(a.chainId),client:e.client,eip712:a.eip712};let s=await oe({account:o,transaction:i});if(t.sponsorGas&&!s.paymaster){const h=await hn({options:{client:e.client,chain:r,bundlerUrl:(p=n.overrides)==null?void 0:p.bundlerUrl,entrypointAddress:(m=n.overrides)==null?void 0:m.entrypointAddress},transaction:s});s={...s,...h}}const c=await ce({account:o,chainId:r.id,eip712Transaction:s}),d=await An({options:{client:e.client,chain:r,bundlerUrl:(u=n.overrides)==null?void 0:u.bundlerUrl,entrypointAddress:(A=n.overrides)==null?void 0:A.entrypointAddress},transaction:s,signedTransaction:c});return _({client:e.client,chainId:r.id,transactionHash:d.transactionHash,walletAddress:o.address,walletType:"smart",contractAddress:a.to??void 0}),{transactionHash:d.transactionHash,client:e.client,chain:r}},async signMessage({message:a}){return e.personalAccount.signMessage({message:a})},async signTypedData(a){const i=se(a);return e.personalAccount.signTypedData(i)},async onTransactionRequested(a){var i,s;return(s=(i=e.personalAccount).onTransactionRequested)==null?void 0:s.call(i,a)}};return o}async function q(t){var r,o,a;const{executeTx:n,options:e}=t;try{const i=await sn({transaction:n,factoryContract:e.factoryContract,accountContract:e.accountContract,adminAddress:e.personalAccount.address,sponsorGas:e.sponsorGas,overrides:e.overrides}),s=await dn({client:e.client,chain:e.chain,adminAccount:e.personalAccount,entrypointAddress:(r=e.overrides)==null?void 0:r.entrypointAddress,userOp:i}),c={chain:e.chain,client:e.client,bundlerUrl:(o=e.overrides)==null?void 0:o.bundlerUrl,entrypointAddress:(a=e.overrides)==null?void 0:a.entrypointAddress},d=await yn({options:c,userOp:s}),p=await an({...c,userOpHash:d});return _({client:e.client,chainId:e.chain.id,transactionHash:p.transactionHash,walletAddress:e.accountContract.address,walletType:"smart",contractAddress:await F(n.to??void 0)}),{client:e.client,chain:e.chain,transactionHash:p.transactionHash}}finally{Ot(e.accountContract)}}async function Et(t,n,e){const r=O({address:t,client:n,chain:e});try{return await D({contract:r,method:"function entrypoint() public view returns (address)"})}catch{return}}const xn=Object.freeze(Object.defineProperty({__proto__:null,connectSmartAccount:wn,disconnectSmartAccount:Gn,getEntrypointFromFactory:Et,isSmartWallet:re},Symbol.toStringTag,{value:"Module"}));export{xn as i,Tt as p};
